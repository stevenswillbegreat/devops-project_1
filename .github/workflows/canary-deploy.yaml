name: Canary Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      canary_percentage:
        description: 'Canary traffic percentage'
        required: true
        default: '10'
        type: choice
        options:
        - '10'
        - '25'
        - '50'
        - '100'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: stevenswillbegreat/devops-project_1

jobs:
  canary-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        if: github.event.inputs.environment == 'production'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Setup kubectl
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            aws eks update-kubeconfig --region us-west-2 --name aws-prod
          else
            echo "${{ secrets.HETZNER_KUBECONFIG }}" | base64 -d > ~/.kube/config
          fi

      - name: Deploy Canary
        run: |
          # Deploy canary version
          helm upgrade --install api-canary ./infra/helm/api \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api \
            --set image.tag=${{ github.sha }} \
            --set nameOverride=api-canary \
            --set service.name=api-canary \
            --namespace app-workload

          # Update Istio VirtualService for traffic splitting
          kubectl apply -f - <<EOF
          apiVersion: networking.istio.io/v1beta1
          kind: VirtualService
          metadata:
            name: api-canary
            namespace: app-workload
          spec:
            hosts:
            - api
            http:
            - match:
              - headers:
                  canary:
                    exact: "true"
              route:
              - destination:
                  host: api-canary
                weight: 100
            - route:
              - destination:
                  host: api
                weight: ${{ 100 - github.event.inputs.canary_percentage }}
              - destination:
                  host: api-canary
                weight: ${{ github.event.inputs.canary_percentage }}
          EOF

      - name: Monitor Canary
        run: |
          echo "Monitoring canary deployment for 5 minutes..."
          sleep 300
          
          # Check error rates
          ERROR_RATE=$(kubectl exec -n observability deployment/prometheus -- \
            promtool query instant 'rate(http_requests_total{job="api-canary",status=~"5.."}[5m]) / rate(http_requests_total{job="api-canary"}[5m]) * 100')
          
          if (( $(echo "$ERROR_RATE > 5" | bc -l) )); then
            echo "High error rate detected: $ERROR_RATE%. Rolling back..."
            kubectl delete virtualservice api-canary -n app-workload
            helm uninstall api-canary -n app-workload
            exit 1
          fi
          
          echo "Canary deployment successful. Error rate: $ERROR_RATE%"

      - name: Promote Canary
        if: github.event.inputs.canary_percentage == '100'
        run: |
          # Replace main deployment with canary
          helm upgrade api ./infra/helm/api \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api \
            --set image.tag=${{ github.sha }} \
            --namespace app-workload
          
          # Cleanup canary resources
          kubectl delete virtualservice api-canary -n app-workload
          helm uninstall api-canary -n app-workload
          
          echo "Canary promoted to production"